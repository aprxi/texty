# Rust WebRS Makefile for building native and WASM versions

.PHONY: help build build-wasm build-native test test-wasm clean install-tools export-onnx default copy-onnx run dist

# Default target - copy ONNX and build
default: copy-onnx build

# Copy ONNX artifacts from root artifacts directory
copy-onnx:
	@echo "ğŸ“‹ Copying ONNX artifacts..."
	@if [ ! -d "../../artifacts/models/onnx" ]; then \
		echo "âŒ Error: ONNX artifacts not found at ../../artifacts/models/onnx/"; \
		echo "âš ï¸  Please run 'make onnx' in the root of the repository first."; \
		exit 1; \
	fi
	@if [ ! -f "../../artifacts/models/onnx/base_model_classifier.onnx" ]; then \
		echo "âŒ Error: Required ONNX model files not found."; \
		echo "âš ï¸  Please run 'make onnx' in the root of the repository first."; \
		exit 1; \
	fi
	@mkdir -p ./build/models
	@cp -r ../../artifacts/models/onnx/* ./build/models/
	@echo "âœ… ONNX artifacts copied to ./build/models/"
	@echo "Files copied:"
	@ls -la ./build/models/

# Help target
help:
	@echo "Texty WebRS - Rust/WASM Text Classification"
	@echo "==========================================="
	@echo ""
	@echo "ğŸ¦€ BUILD TARGETS:"
	@echo "  build         - Build both native and WASM versions"
	@echo "  build-native  - Build native Rust library"
	@echo "  build-wasm    - Build WASM version for web"
	@echo ""
	@echo "ğŸ§ª TESTING:"
	@echo "  test          - Run all tests"
	@echo "  test-wasm     - Test WASM build"
	@echo ""
	@echo "ğŸ”§ TOOLS:"
	@echo "  install-tools - Install required tools (wasm-pack, etc.)"
	@echo "  copy-onnx     - Copy ONNX artifacts from ../../artifacts/models/onnx/"
	@echo "  run           - Start development server (requires build first)"
	@echo "  dist          - Build distribution for static hosting"
	@echo ""
	@echo "ğŸ§¹ CLEANUP:"
	@echo "  clean         - Clean build artifacts"

# Install required tools for WASM development
install-tools:
	@echo "ğŸ“¦ Installing required tools..."
	@if ! command -v wasm-pack >/dev/null 2>&1; then \
		echo "Installing wasm-pack..."; \
		curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh; \
	else \
		echo "âœ… wasm-pack already installed"; \
	fi
	@if ! command -v cargo-generate >/dev/null 2>&1; then \
		echo "Installing cargo-generate..."; \
		cargo install cargo-generate; \
	else \
		echo "âœ… cargo-generate already installed"; \
	fi

# Build both native and WASM versions
build: build-native build-wasm

# Build native Rust library
build-native:
	@echo "ğŸ¦€ Building native Rust library..."
	cargo build --release
	@echo "âœ… Native build complete!"

# Build WASM version
build-wasm: install-tools
	@echo "ğŸŒ Building WASM version..."
	wasm-pack build --target web --out-dir pkg --features wasm
	@echo "âœ… WASM build complete! Output in pkg/"

# Build for Node.js/bundler environments
build-wasm-bundler: install-tools
	@echo "ğŸ“¦ Building WASM for bundlers..."
	wasm-pack build --target bundler --out-dir pkg-bundler --features wasm

# Development build (faster compilation)
build-dev:
	@echo "ğŸš§ Building development version..."
	cargo build
	@echo "âœ… Development build complete!"

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	cargo test
	@echo "âœ… Tests complete!"

# Test WASM build
test-wasm: build-wasm
	@echo "ğŸŒ Testing WASM build..."
	wasm-pack test --headless --firefox --features wasm
	@echo "âœ… WASM tests complete!"

# Export ONNX model from Python
export-onnx:
	@echo "ğŸ”„ Exporting Python model to ONNX..."
	@if [ ! -f "../../artifacts/models/base.latest.pkl" ]; then \
		echo "âŒ No trained model found. Run 'make train' in the root directory first."; \
		exit 1; \
	fi
	@mkdir -p ../../artifacts/models/onnx
	@echo "ğŸ³ Running ONNX export in container..."
	cd ../.. && $(MAKE) onnx-container
	@echo "âœ… ONNX export complete! Files saved to ../../artifacts/models/onnx/"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cargo clean
	rm -rf pkg pkg-bundler build
	@echo "âœ… Clean complete!"

# Generate documentation
docs:
	@echo "ğŸ“š Generating documentation..."
	cargo doc --no-deps --features wasm
	@echo "âœ… Documentation generated! Open target/doc/texty_webrs/index.html"

# Run clippy for linting
lint:
	@echo "ğŸ” Running clippy..."
	cargo clippy --all-targets --features wasm -- -D warnings
	@echo "âœ… Lint complete!"

# Format code
fmt:
	@echo "ğŸ¨ Formatting code..."
	cargo fmt
	@echo "âœ… Formatting complete!"

# Check code without building
check:
	@echo "ğŸ” Checking code..."
	cargo check --features wasm
	@echo "âœ… Check complete!"

# Benchmark (if benchmark tests are added)
bench:
	@echo "âš¡ Running benchmarks..."
	cargo bench
	@echo "âœ… Benchmarks complete!"

# Watch for changes and rebuild
watch:
	@if ! command -v cargo-watch >/dev/null 2>&1; then \
		echo "Installing cargo-watch..."; \
		cargo install cargo-watch; \
	fi
	@echo "ğŸ‘€ Watching for changes..."
	cargo watch -x "build --features wasm"

# Run development server (serves the built WASM)
run:
	@echo "ğŸš€ Starting WebRS development server..."
	@if [ ! -d "./build" ]; then \
		echo "âŒ Build directory not found. Run 'make webrs' first."; \
		exit 1; \
	fi
	@if [ ! -d "./pkg" ]; then \
		echo "âŒ WASM package not found. Building now..."; \
		$(MAKE) build-wasm; \
	fi
	@echo "Starting simple HTTP server on port 8080..."
	@echo "Open http://localhost:8080 in your browser"
	@echo "Press Ctrl+C to stop"
	python3 -m http.server 8080 || python -m http.server 8080 || echo "Error: Python not found. Install Python to run the dev server."

# Build distribution for static hosting
dist: copy-onnx build-wasm
	@echo "ğŸ“¦ Creating distribution directory..."
	@rm -rf dist
	@mkdir -p dist
	@echo "ğŸ“‹ Copying static files..."
	@cp index.html dist/
	@cp favicon.ico dist/ 2>/dev/null || echo "âš ï¸  No favicon found, skipping..."
	@echo "ğŸ“¦ Copying WASM package..."
	@cp -r pkg dist/
	@echo "ğŸ“‹ Copying ONNX models..."
	@cp -r build dist/
	@echo "âœ… Distribution created in ./dist/"
	@echo ""
	@echo "ğŸ“ Distribution contents:"
	@ls -la dist/
	@echo ""
	@echo "ğŸŒ To host these files:"
	@echo "   - Upload the contents of ./dist/ to your web server"
	@echo "   - Ensure your server serves .wasm files with Content-Type: application/wasm"
	@echo "   - All files should be served from the same directory"